<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coin Catch Slime</title>
    <style>
        body { 
            margin: 0; height: 100vh; display: flex; flex-direction: column; 
            background: #fff9c4; font-family: sans-serif; overflow: hidden; touch-action: none; 
        }
        
        /* 上下の広告エリア：150px（中サイズ対応） */
        #ad-top, #ad-bottom { 
            width: 100%; height: 150px; background: #333; 
            display: flex; align-items: center; justify-content: center; flex-shrink: 0; z-index: 100;
        }
        iframe { border: none; width: 100%; height: 100%; }

        /* ゲームエリア */
        #game-area { 
            flex-grow: 1; position: relative; width: 100%; background: #fff176; overflow: hidden;
        }
        
        canvas { display: block; width: 100%; height: 100%; }
        
        #ui { position: absolute; top: 10px; width: 100%; text-align: center; color: #f57f17; font-size: 26px; font-weight: bold; pointer-events: none; z-index: 10; text-shadow: 1px 1px 2px white; }
        
        /* メニュー画面：鉄壁レイアウト */
        #menuScreen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.95); display: flex; flex-direction: column; 
            align-items: center; justify-content: space-between; z-index: 200; padding: 10px 0; box-sizing: border-box;
        }

        #ad-middle-container { 
            width: 300px; height: 250px; background: #ddd;
            display: none; justify-content: center; align-items: center; 
            overflow: hidden; flex-shrink: 0; border: 1px solid #ccc;
        }
        
        .btn-group { 
            display: flex; flex-direction: column; align-items: center; gap: 8px; 
            width: 100%; padding-bottom: 5px;
        }
        .menu-btn { padding: 12px 30px; font-size: 17px; border: none; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; text-decoration: none; width: 220px; text-align: center; }
        #goButton { background: #fb8c00; box-shadow: 0 4px #e67e22; }
        .link-btn { background: #ff4081; box-shadow: 0 4px #c2185b; }
        .best-info { color: #f57f17; font-size: 18px; font-weight: bold; margin: 2px 0; }
    </style>
</head>
<body>
    <div id="ad-top"><iframe src="ad.html" id="frame-top"></iframe></div>

    <div id="game-area">
        <div id="ui">SCORE: 0</div>
        
        <div id="menuScreen">
            <div style="text-align:center;">
                <h1 id="menuTitle" style="color:#f57f17; margin:0; font-size: 24px;">COIN CATCH</h1>
                <p id="menuMsg" style="margin:2px 0; font-size:14px;">左右スライドでコインを拾え！</p>
                <div class="best-info">BEST SCORE: <span id="best-ui">0</span></div>
            </div>

            <div id="ad-middle-container">
                <script src="https://adm.shinobi.jp/s/1e6de436ea850948e238e975a93767eb"></script>
            </div>

            <div class="btn-group" id="btnGroup">
                <button id="goButton" class="menu-btn">GAME START</button>
                <a href="https://saaaachi.github.io/Color.Match/" class="menu-btn link-btn">他のゲームはこちら</a>
            </div>
        </div>
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="ad-bottom"><iframe src="ad.html" id="frame-bottom"></iframe></div>

    <script>
        const canvas = document.getElementById("gameCanvas"), ctx = canvas.getContext("2d"),
              ui = document.getElementById("ui"), menuScreen = document.getElementById("menuScreen"),
              menuTitle = document.getElementById("menuTitle"), menuMsg = document.getElementById("menuMsg"),
              bestUi = document.getElementById("best-ui"), goButton = document.getElementById("goButton"),
              adMid = document.getElementById("ad-middle-container"), btnGroup = document.getElementById("btnGroup");

        let score = 0, bestScore = localStorage.getItem("coin_catch_best") || 0;
        let gameActive = false, items = [], playerX, spawnTimer;
        const playerSize = 35, playerY_offset = 50;

        function resize() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            playerX = canvas.width / 2;
        }
        window.onload = () => { resize(); bestUi.innerText = bestScore; adMid.style.display = "none"; };
        window.onresize = resize;

        goButton.onclick = () => {
            menuScreen.style.display = "none";
            adMid.style.display = "none";
            gameActive = true;
            score = 0;
            items = [];
            ui.innerText = "SCORE: 0";
            resize();
            spawnItem();
            update();
        };

        function handleMove(e) {
            if(!gameActive || menuScreen.style.display !== "none") return;
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            playerX = clientX - rect.left;
            
            if(playerX < playerSize) playerX = playerSize;
            if(playerX > canvas.width - playerSize) playerX = canvas.width - playerSize;
        }

        canvas.addEventListener("touchmove", (e) => { handleMove(e); e.preventDefault(); }, {passive: false});
        canvas.addEventListener("mousemove", handleMove);

        function spawnItem() {
            if(!gameActive) return;
            const isBomb = Math.random() < 0.25;
            items.push({
                x: Math.random() * (canvas.width - 40) + 20,
                y: -30,
                type: isBomb ? "bomb" : "coin",
                speed: 3.5 + Math.random() * 3 + (score / 100)
            });
            const nextTime = Math.max(250, 750 - (score / 2));
            spawnTimer = setTimeout(spawnItem, nextTime);
        }

        function update() {
            if(!gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const pY = canvas.height - playerY_offset;

            // プレイヤー描画
            ctx.fillStyle = "#4caf50";
            ctx.beginPath();
            ctx.arc(playerX, pY, playerSize, 0, Math.PI, true);
            ctx.fill();
            ctx.fillStyle = "white";
            ctx.beginPath(); ctx.arc(playerX - 10, pY - 15, 5, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(playerX + 10, pY - 15, 5, 0, Math.PI * 2); ctx.fill();

            for(let i = items.length - 1; i >= 0; i--) {
                let it = items[i];
                it.y += it.speed;

                if(it.type === "coin") {
                    ctx.fillStyle = "#ffd600";
                    ctx.beginPath(); ctx.arc(it.x, it.y, 15, 0, Math.PI * 2); ctx.fill();
                    ctx.strokeStyle = "#f57f17"; ctx.lineWidth = 2; ctx.stroke();
                } else {
                    ctx.fillStyle = "#212121";
                    ctx.beginPath(); ctx.arc(it.x, it.y, 18, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = "red"; ctx.fillRect(it.x - 2, it.y - 28, 4, 10);
                }

                let dx = playerX - it.x;
                let dy = pY - it.y;
                let dist = Math.sqrt(dx * dx + dy * dy);

                if(dist < playerSize + 12) {
                    if(it.type === "coin") {
                        score += 10;
                        ui.innerText = "SCORE: " + score;
                        items.splice(i, 1);
                    } else {
                        gameOver();
                        return;
                    }
                } else if(it.y > canvas.height + 50) {
                    items.splice(i, 1);
                }
            }
            requestAnimationFrame(update);
        }

        function gameOver() {
            gameActive = false;
            clearTimeout(spawnTimer);
            if(score > bestScore) {
                bestScore = score;
                localStorage.setItem("coin_catch_best", bestScore);
                bestUi.innerText = bestScore;
            }
            menuTitle.innerText = "GAME OVER";
            menuTitle.style.color = "#f44336";
            menuMsg.innerText = "SCORE: " + score;
            goButton.innerText = "RETRY";

            btnGroup.style.opacity = "0";
            btnGroup.style.pointerEvents = "none";
            adMid.style.display = "flex"; 
            menuScreen.style.display = "flex";

            setTimeout(() => {
                btnGroup.style.opacity = "1";
                btnGroup.style.pointerEvents = "auto";
            }, 600);
        }

        setInterval(() => {
            document.querySelectorAll('iframe').forEach(f => {
                const s = f.src; f.src = "about:blank"; setTimeout(() => f.src = s, 100);
            });
        }, 30000);
    </script>
</body>
</html>
